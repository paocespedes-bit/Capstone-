{% extends "base.html" %}
{% load static %}
{% load myfilters %}
{% block link %}
<link rel="stylesheet" href="{% static 'cart/css/carrito.css' %}" />
{% endblock %}

{% block title %}Carrito de Compras{% endblock %}

{% block content %}
<div class="col-md-8">
  <h1>Carrito</h1>
  <div id="lista-carrito"></div>
  <button class="btn btn-danger mt-3" onclick="vaciarCarrito()">Vaciar Carrito</button>
</div>

<div class="col-md-4">
  <div class="cart-summary">
    <h4>Resumen de Compra</h4>
    <div id="resumen-carrito"></div>
    <button class="btn btn-primary w-100 mt-3" data-bs-toggle="collapse" data-bs-target="#formularioPago">
      Continuar con Pedido
    </button>
  </div>

  <!-- Formulario colapsable -->
  <div class="collapse mt-3" id="formularioPago">
    <form method="post">
      {% csrf_token %}
      <input class="form-control mb-2" name="comprador" placeholder="Nombre completo">
      <input class="form-control mb-2" name="correo_cli" placeholder="Correo electrónico">
      <input class="form-control mb-2" name="celular_cli" placeholder="Celular">
      <textarea class="form-control mb-2" name="ubicacion_cli" placeholder="Dirección"></textarea>
      <button class="btn btn-success w-100">Confirmar Pedido</button>
    </form>
  </div>
  <p>Hola mundo</p>
  <p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Commodi culpa, vitae officia fuga sit quasi beatae natus? Voluptatem facere ipsa reprehenderit vero repellat quidem at. Dolorum saepe assumenda libero animi.</p>
</div>
{% endblock %}

{% block script %}
<script src="{% static 'eliminar_carrito.js' %}"></script>
<script>
function renderizarCarrito() {
  const contenedor = document.getElementById("lista-carrito");
  const resumen = document.getElementById("resumen-carrito");
  let carrito = JSON.parse(localStorage.getItem("carrito")) || [];

  contenedor.innerHTML = "";
  resumen.innerHTML = "";

  let total = 0;

  carrito.forEach((p, index) => {
    const subtotal = p.precio_unitario * p.cantidad;
    total += subtotal;

    contenedor.innerHTML += `
      <div class="cart-item d-flex align-items-center">
        <div class="flex-grow-1">
          <h5>${p.nombre_producto}</h5>
          <p>${p.content_type} ID: ${p.id}</p>
        </div>
        <input type="number" min="1" value="${p.cantidad}" class="form-control w-25 me-2" onchange="actualizarCantidad(${index}, this.value)">
        <span>$${p.precio_unitario}|floatformat:0|punto_miles</span>
        <button class="btn btn-danger ms-2" onclick="eliminarItem(${index})"><i class="bi bi-trash"></i></button>
      </div>
    `;

    resumen.innerHTML += `
      <div class="d-flex justify-content-between">
        <span>${p.nombre_producto} x ${p.cantidad}</span>
        <strong>$${subtotal.toLocaleString()}</strong>
      </div>
    `;
  });

  resumen.innerHTML += `
    <hr>
    <div class="d-flex justify-content-between">
      <span><strong>Total</strong></span>
      <strong>$${total.toLocaleString()}</strong>
    </div>
  `;
}

function actualizarCantidad(index, nuevaCantidad) {
  let carrito = JSON.parse(localStorage.getItem("carrito")) || [];
  if (nuevaCantidad < 1) nuevaCantidad = 1;
  carrito[index].cantidad = parseInt(nuevaCantidad);
  localStorage.setItem("carrito", JSON.stringify(carrito));
  renderizarCarrito();
}

function eliminarItem(index) {
  let carrito = JSON.parse(localStorage.getItem("carrito")) || [];
  carrito.splice(index, 1);
  localStorage.setItem("carrito", JSON.stringify(carrito));
  renderizarCarrito();
  actualizarBadge();
}

function vaciarCarrito() {
  localStorage.removeItem("carrito");
  renderizarCarrito();
  actualizarBadge();
}

document.addEventListener("DOMContentLoaded", renderizarCarrito);
</script>

{% endblock %}