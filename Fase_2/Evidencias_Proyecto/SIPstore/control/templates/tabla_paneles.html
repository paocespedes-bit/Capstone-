{% load static %}
{% load humanize %}
{% load myfilters %}

{% block link %}
<link rel="stylesheet" href="{% static 'control/style/tablas.css' %}">
{% endblock %}

<div class="container-fluid">
  <!-- Botón filtros (móvil) -->
  <div class="d-flex justify-content-end mb-3 d-md-none">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalFiltros">
      <i class="bi bi-funnel"></i> Filtrar / Ordenar
    </button>
  </div>

  <h2>Tabla de Paneles</h2>

  <!-- Modal filtros (móvil) -->
  <div class="modal fade" id="modalFiltros" tabindex="-1" aria-labelledby="modalFiltrosLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalFiltrosLabel">Filtros y Ordenamiento</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form method="get" action="{% url 'stock' %}">
            <input type="hidden" name="tab" value="paneles">

            <!-- Ordenamiento -->
            <div class="mb-3">
              <label class="form-label">Ordenar por</label>
              <select name="ordenar" class="form-select">
                <option value="">Sin orden</option>
                <option value="id" {% if ordenar == 'id' %}selected{% endif %}>ID</option>
                <option value="nombre" {% if ordenar == 'nombre' %}selected{% endif %}>Nombre</option>
                <option value="precio" {% if ordenar == 'precio' %}selected{% endif %}>Precio</option>
              </select>
            </div>
            <div class="mb-3">
              <select name="direccion" class="form-select">
                <option value="asc" {% if direccion != 'desc' %}selected{% endif %}>Ordenar A-Z / Menor-Mayor</option>
                <option value="desc" {% if direccion == 'desc' %}selected{% endif %}>Ordenar Z-A / Mayor-Menor</option>
              </select>
            </div>

            <hr>

            <!-- Filtros -->
            <div class="mb-3">
              <label class="form-label">Tipo OBS</label>
              <select name="tipo_obs" class="form-select">
                <option value="">Todos</option>
                {% for tipo in tipo_obs_opciones %}
                  <option value="{{ tipo }}" {% if selected_tipo_obs == tipo %}selected{% endif %}>{{ tipo }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Espesor</label>
              <select name="espesor" class="form-select">
                <option value="">Todos</option>
                {% for e in espesor_opciones %}
                  <option value="{{ e|stringformat:"s" }}" {% if selected_espesor|stringformat:"s" == e|stringformat:"s" %}selected{% endif %}>{{ e }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Largo</label>
              <select name="largo" class="form-select">
                <option value="">Todos</option>
                {% for l in largo_opciones %}
                  <option value="{{ l|stringformat:"s" }}" {% if selected_largo|stringformat:"s" == l|stringformat:"s" %}selected{% endif %}>{{ l }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Ancho</label>
              <select name="ancho" class="form-select">
                <option value="">Todos</option>
                {% for a in ancho_opciones %}
                  <option value="{{ a|stringformat:"s" }}" {% if selected_ancho|stringformat:"s" == a|stringformat:"s" %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="d-flex justify-content-between mt-4">
              <a href="{% url 'stock' %}?tab=paneles" class="btn btn-outline-secondary">Limpiar</a>
              <button type="submit" class="btn btn-success">Aplicar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla principal -->
  <form method="get" action="{% url 'stock' %}">
    <input type="hidden" name="tab" value="paneles">
    <div class="table-responsive mb-5">
      <table class="table table-hover table-striped align-middle">
        <thead>
          <tr>
            <th>
              ID
              <div class="dropdown d-inline">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownID" data-bs-toggle="dropdown" aria-expanded="false"></button>
                <ul class="dropdown-menu" aria-labelledby="dropdownID">
                  <li><a class="dropdown-item" href="?tab=paneles&ordenar=id&direccion=asc">Menor-Mayor</a></li>
                  <li><a class="dropdown-item" href="?tab=paneles&ordenar=id&direccion=desc">Mayor-Menor</a></li>
                </ul>
              </div>
            </th>
            <th>Cantidad</th>
            <th>
              Nombre
              <div class="dropdown d-inline">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownNombre" data-bs-toggle="dropdown" aria-expanded="false"></button>
                <ul class="dropdown-menu" aria-labelledby="dropdownNombre">
                  <li><a class="dropdown-item" href="?tab=paneles&ordenar=nombre&direccion=asc">A-Z</a></li>
                  <li><a class="dropdown-item" href="?tab=paneles&ordenar=nombre&direccion=desc">Z-A</a></li>
                </ul>
              </div>
            </th>
            <th>
              Precio
              <div class="dropdown d-inline">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownPrecio" data-bs-toggle="dropdown" aria-expanded="false"></button>
                <ul class="dropdown-menu" aria-labelledby="dropdownPrecio">
                  <li><a class="dropdown-item" href="?tab=paneles&ordenar=precio&direccion=asc">Menor-Mayor</a></li>
                  <li><a class="dropdown-item" href="?tab=paneles&ordenar=precio&direccion=desc">Mayor-Menor</a></li>
                </ul>
              </div>
            </th>
            <th>Oferta</th>
            <th>Descripción</th>
            <th class="d-none d-md-table-cell">
              <select name="tipo_obs" class="form-select" onchange="this.form.submit()">
                <option value="">Tipo OBS</option>
                {% for tipo in tipo_obs_opciones %}
                  <option value="{{ tipo }}" {% if selected_tipo_obs == tipo %}selected{% endif %}>{{ tipo }}</option>
                {% endfor %}
              </select>
            </th>
            <th class="d-none d-md-table-cell">
              <select name="espesor" class="form-select" onchange="this.form.submit()">
                <option value="">Espesor</option>
                {% for e in espesor_opciones %}
                  <option value="{{ e|stringformat:"s" }}" {% if selected_espesor|stringformat:"s" == e|stringformat:"s" %}selected{% endif %}>{{ e }}</option>
                {% endfor %}
              </select>
            </th>
            <th class="d-none d-md-table-cell">
              <select name="largo" class="form-select" onchange="this.form.submit()">
                <option value="">Largo</option>
                {% for l in largo_opciones %}
                  <option value="{{ l|stringformat:"s" }}" {% if selected_largo|stringformat:"s" == l|stringformat:"s" %}selected{% endif %}>{{ l }}</option>
                {% endfor %}
              </select>
            </th>
            <th class="d-none d-md-table-cell">
              <select name="ancho" class="form-select" onchange="this.form.submit()">
                <option value="">Ancho</option>
                {% for a in ancho_opciones %}
                  <option value="{{ a|stringformat:"s" }}" {% if selected_ancho|stringformat:"s" == a|stringformat:"s" %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
              </select>
            </th>
            <th>Categorías</th>
            <th>Imágenes</th>
            <th class="text-center">Acciones</th>
            <th>+ Imagenes</th>
            <th>- Imagenes</th>
          </tr>
        </thead>
        <tbody>
          {% for panel in paneles %}
          <tr>
            <td data-label="ID" >#{{ panel.id }}</td>
            
              {% if panel.inventario.first.modo_stock == 'stock' %}
                {% if panel.inventario.first.disponible == 0 %}<td data-label="Cantidad" title="Sin Stock - Reservado: {{ panel.inventario.first.reservado }} ">Sin Stock</td>
                {% else %}<td data-label="Cantidad" title="Disponible: {{ panel.inventario.first.disponible }} - Reservado: {{ panel.inventario.first.reservado }} ">{{ panel.inventario.first.disponible }}</td>
                {% endif %}
              {% else %}<td data-label="Cantidad" title="Por Pedido">Por Pedido</td>
              {% endif %}
            
            <td data-label="Nombre" >{{ panel.nombre }}</td>
            <td data-label="Precio" >${{ panel.precio|floatformat:0|punto_miles }}</td>
            <td data-label="Oferta" >{% if panel.oferta %}{{ panel.oferta }}%{% else %}N/A{% endif %}</td>
            <td data-label="Descripción" title="{{ panel.descripcion }}">{{ panel.descripcion|truncatechars:20 }}...</td>
            <td data-label="Tipo OBS" >{{ panel.tipo_obs }}</td>
            <td data-label="Espesor" >{{ panel.espesor }}</td>
            <td data-label="Largo" >{{ panel.largo }}</td>
            <td data-label="Ancho" >{{ panel.ancho }}</td>
            <td data-label="Categorías" >
              {% for cat in panel.categorias.all %}
                <span class="badge bg-secondary">{{ cat.nombre }}</span>
              {% endfor %}
            </td>
            <td data-label="Imágenes" >
              <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#galeriaPanel_{{ panel.id }}">
                <i class="bi bi-eye"></i> Ver({{ panel.imagenes.count }})
              </button>
            </td>
            <td data-label="Acciones" class="text-center">
              <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalEditarPanel_{{ panel.id }}">
                Editar <i class="bi bi-pencil-square"></i>
              </button>
              <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalEliminarPanel_{{ panel.id }}">
                Eliminar
              </button>
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#modalSubirImagenes_{{ panel.id }}">
                + <i class="bi bi-image-fill"></i>
              </button>
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#modalEliminarImagenes_{{ panel.id }}">
                - <i class="bi bi-image-fill"></i>
              </button>
            </td>
          </tr>
          {% include 'imagenes.html' %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>

{% block script %}
<script src="{% static 'control/js/eliminar.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const modalFiltros = document.getElementById("modalFiltros");
  const formFiltros = modalFiltros.querySelector("form");
  formFiltros.addEventListener("submit", function (e) {
    e.preventDefault();
    const query = new URLSearchParams(new FormData(this)).toString();
    window.location.href = `{% url 'stock' %}?${query}`;
  });
});
</script>
{% endblock %}
