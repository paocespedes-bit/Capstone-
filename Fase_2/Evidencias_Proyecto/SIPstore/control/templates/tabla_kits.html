{% load static %}
{% load myfilters %}

{% block link %}
<link rel="stylesheet" href="{% static 'control/style/tablas.css' %}">
{% endblock %}
<script>
    const editButtons = document.querySelectorAll('.btn-editar-kit');

    editButtons.forEach(button => {
        button.addEventListener('click', function () {
            const kitId = this.dataset.id;
            const modal = document.getElementById(`modalEditarKit_${kitId}`);
            const form = modal.querySelector('#formEditarKit');

            // Actualizar la acción del formulario
            form.action = `/editar-kit/${kitId}/`;

            // Rellenar los inputs
            form.querySelector('[name="nombre"]').value = this.dataset.nombre;
            form.querySelector('[name="precio"]').value = this.dataset.precio;
            form.querySelector('[name="descripcion"]').value = this.dataset.descripcion;
            form.querySelector('[name="m2"]').value = this.dataset.m2;
            form.querySelector('[name="dormitorios"]').value = this.dataset.dormitorios;
            form.querySelector('[name="banos"]').value = this.dataset.banos;

            // Para categorías múltiples
            const categorias = this.dataset.categorias.split(',');
            const select = form.querySelector('[name="categorias"]');
            Array.from(select.options).forEach(option => {
                option.selected = categorias.includes(option.value);
            });
        });
    });
</script>

<div class="container-fluid">
    <h2>Tabla de Kits</h2>
    <div class="table-responsive">
        <table class="table table-hover table-striped align-middle">
            <thead class="table">
                <tr>
                    <th>ID
                        {% include 'filtro_columna.html' with columna_nombre="id" %}
                    </th>
                    <th>Cantidad
                        {% include 'filtro_columna.html' with columna_nombre="cantidad" %}
                    </th>
                    <th>Nombre
                        {% include 'filtro_columna.html' with columna_nombre="nombre" %}
                    </th>
                    <th>Precio
                        {% include 'filtro_columna.html' with columna_nombre="precio" %}
                    </th>
                    <th>Oferta
                        {% include 'filtro_columna.html' with columna_nombre="oferta" %}
                    </th>
                    <th>Descripción</th>
                    <th>m²
                        {% include 'filtro_columna.html' with columna_nombre="m2" %}
                    </th>
                    <th>Dormitorios
                        {% include 'filtro_columna.html' with columna_nombre="dormitorios" %}
                    </th>
                    <th>Baños
                        {% include 'filtro_columna.html' with columna_nombre="banos" %}
                    </th>
                    <th>Categorías
                        {% include 'filtro_columna.html' with columna_nombre="categorias" %}
                    </th>
                    <th>Imágenes</th>
                    <th class="text-center">Acciones</th>
                    <th>+ Imagenes</th>
                    <th>- Imagenes</th>
                </tr>
            </thead>
            <tbody>
                {% for kit in kits %}
                <tr>
                    <td>#{{ kit.id }}</td>
                    <td>
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#modalInventarioKit_{{ kit.id }}">
                            Stock <i class="bi bi-pencil-square"></i>
                        </button>
                    </td>
                    <td>{{ kit.nombre }}</td>
                    <td>${{ kit.precio_actual|floatformat:0|punto_miles }}</td>
                    <td>
                        {% if kit.oferta %}
                        {{ kit.oferta }}%
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                    <td title="{{ kit.descripcion }}">{{ kit.descripcion|truncatechars:20 }}...</td>
                    <td>{{ kit.m2 }}</td>
                    <td>{{ kit.dormitorios }}</td>
                    <td>{{ kit.banos }}</td>
                    <td>
                        {% for cat in kit.categorias.all %}
                        <span class="badge bg-secondary">{{ cat.nombre }}</span>
                        {% endfor %}
                    </td>
                    <td>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#galeriaKit_{{ kit.id }}">
                            <i class="bi bi-eye"></i> Ver({{ kit.imagenes.count }})
                        </button>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary btn-editar-kit" data-bs-toggle="modal"
                            data-bs-target="#modalEditarKit_{{ kit.id }}" data-id="{{ kit.id }}"
                            data-nombre="{{ kit.nombre }}" data-precio="{{ kit.precio }}"
                            data-descripcion="{{ kit.descripcion }}" data-m2="{{ kit.m2 }}"
                            data-dormitorios="{{ kit.dormitorios }}" data-banos="{{ kit.banos }}"
                            data-categorias="{{ kit.categorias.all|join:',' }}">
                            Editar
                        </button>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                            data-bs-target="#modalEliminarKit_{{ kit.id }}">
                            Eliminar
                        </button>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal"
                            data-bs-target="#modalSubirImagenesKit_{{ kit.id }}">
                            + <i class="bi bi-image-fill"></i>
                        </button>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal"
                            data-bs-target="#modalEliminarImagenesKit_{{ kit.id }}">
                            - <i class="bi bi-image-fill"></i>
                        </button>
                    </td>
                    {% include 'imagenes.html' %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% block script %}
<script src="{% static 'control/js/eliminar.js' %}"></script>
{% endblock %}